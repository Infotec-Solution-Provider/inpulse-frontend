"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8702],{28450:(t,e,n)=>{n.d(e,{d:()=>p,A:()=>f});var a=n(95155),c=n(54607),o=n(12115),r=n(98892),s=n(92697),i=n(3127),u=n(31857),l=n(69242);function d(t){let{qr:e,phone:n}=t,{closeModal:c}=(0,o.useContext)(s.BR);return(0,a.jsxs)("div",{className:"flex h-max w-max flex-col items-center gap-2 rounded-md bg-slate-400 px-6 py-4 text-slate-800",children:[(0,a.jsxs)("div",{className:"flex w-full items-center justify-between",children:[(0,a.jsxs)("h1",{className:"text-lg font-semibold",children:[" QrCode: ",n," "]}),(0,a.jsx)(i.A,{onClick:c,children:(0,a.jsx)(l.A,{sx:{pointerEvents:"none"}})})]}),(0,a.jsx)(u.h,{value:e,height:480,width:480})]})}var h=n(38543);let p=(0,o.createContext)({});function f(t){let{children:e}=t,{token:n}=(0,o.useContext)(r.c),{openModal:i,closeModal:u}=(0,o.useContext)(s.BR),l=(0,o.useRef)(new c.SocketClient("https://socket.infotecrs.inf.br"));return(0,o.useEffect)(()=>{n?l.current.connect(n):l.current.disconnect()},[n,l]),(0,o.useEffect)(()=>{let t=l.current;return t.on(c.SocketEventType.WwebjsQr,t=>{let{qr:e,phone:n}=t;i((0,a.jsx)(d,{qr:e,phone:n}))}),t.on(c.SocketEventType.WwebjsAuth,t=>{let{phone:e,success:n,message:a}=t;n?h.oR.success("N\xfamero ".concat(e," autenticado com sucesso!")):h.oR.error("Erro ao autenticar n\xfamero ".concat(e,": ").concat(a))}),()=>{t.off(c.SocketEventType.WwebjsQr),t.off(c.SocketEventType.WwebjsAuth)}},[l,u,i]),(0,a.jsx)(p.Provider,{value:{socket:l.current},children:e})}},37345:(t,e,n)=>{n.d(e,{A:()=>a});let a=function(t,e){return"PENDING"===t?e:"SENT"===t&&"PENDING"===e||"RECEIVED"===t&&["SENT","PENDING"].includes(e)||"READ"===t&&["SENT","PENDING","RECEIVED"].includes(e)?t:e}},49271:(t,e,n)=>{n.d(e,{A:()=>a});let a=new(n(54607)).UsersClient("https://inpulse.infotecrs.inf.br")},58035:(t,e,n)=>{n.d(e,{A:()=>a});let a={src:"/_next/static/media/hlogodark.58e397dd.png",height:590,width:982,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAFCAMAAABPT11nAAAAP1BMVEVMaXHiIiW/PwDsPiPpMiOJJI3sKiXpJSTbLyPxLiXtQyTrNCX1QiTsKiSuIln1LSexH0u5IkPdKSr9LCn/PyjHk6odAAAAE3RSTlMAsgTPUUXjOhXt2LryKsjxc1/iTlJkQAAAAAlwSFlzAAAuIwAALiMBeKU/dgAAABh0RVh0U29mdHdhcmUAUGFpbnQuTkVUIDUuMS40Et+mgwAAAC1JREFUeJwFwYcBACAIwLCKIu79/60mAELyBQid+hqaZnQ3B3ScfKMBa5sz5AMV3wEXXx6ffwAAAABJRU5ErkJggg==",blurWidth:8,blurHeight:5}},67737:(t,e,n)=>{n.d(e,{X:()=>a});function a(t,e){"Notification"in window&&"granted"===Notification.permission&&new Notification(t,e)}},88702:(t,e,n)=>{n.d(e,{M1:()=>A,ce:()=>g,Ay:()=>v,jb:()=>C});var a=n(95155),c=n(12115),o=n(54607),r=n(98892),s=n(28450);function i(t,e){e.sort((t,e)=>(t.timestamp||0)<(e.timestamp||0)?-1:1);let n={},a={};for(let t of e){let e=t.contactId||0;a[e]||(a[e]=[]),a[e].push(t),(!n[e]||t.timestamp>n[e].timestamp)&&(n[e]=t)}let c=t=>t.from.startsWith("me:")||"system"===t.from,o=[];for(let a of t){let t={...a,chatType:"wpp",isUnread:e.some(t=>t.contactId===a.contactId&&"READ"!==t.status&&!c(t)),lastMessage:a.contactId&&n[a.contactId]||null};o.push(t)}return o.sort((t,e)=>{var n,a;return((null===(n=t.lastMessage)||void 0===n?void 0:n.timestamp)||0)<((null===(a=e.lastMessage)||void 0===a?void 0:a.timestamp)||0)?1:-1}),{detailedChats:o,chatsMessages:a}}var u=n(37345),l=n(67737),d=n(42732),h=n(58035);let p={image:"Enviou uma imagem.",video:"Enviou um v\xeddeo.",audio:"Enviou um \xe1udio.",ptt:"Enviou uma mensagem de voz.",document:"Enviou um documento.",file:"Enviou um arquivo."};function f(t,e){switch(e.type){case"change-showing-type":return{...t,showingType:e.showingType};case"change-search":return{...t,search:e.search};case"reset-filters":return{showingType:"all",search:""};default:return t}}var m=n(38543);let A="https://inpulse.infotecrs.inf.br",g=(0,c.createContext)({});function v(t){let{children:e}=t,{token:n,user:v,instance:C}=(0,c.useContext)(r.c),{socket:y}=(0,c.useContext)(s.d),[E,I]=(0,c.useState)([]),[w,S]=(0,c.useState)(null),k=(0,c.useRef)(null),[x,b]=(0,c.useState)([]),[T,R]=(0,c.useState)({}),[M,N]=(0,c.useState)([]),W=(0,c.useRef)(new o.WhatsappClient(A)),[B,P]=(0,c.useState)([]),[j,U]=(0,c.useState)([]),[D,X]=(0,c.useState)([]),[F,L]=(0,c.useState)([]),[Q,V]=(0,c.useReducer)(f,{search:"",showingType:"all"}),z=(0,c.useCallback)(t=>{S(t),b(T[t.contactId||0]||[]),k.current=t,t.contactId&&(W.current.markContactMessagesAsRead(t.contactId),I(e=>e.map(e=>e.id===t.id?{...e,isUnread:!1}:e)))},[T]),J=(0,c.useCallback)((t,e)=>{I(n=>n.map(n=>n.contact&&n.contactId===t?{...n,contact:{...n.contact,name:e}}:n)),w&&"wpp"===w.chatType&&w.contactId===t&&S(t=>(t.contact.name=e,t))},[w]),K=(0,c.useCallback)((t,e)=>{W.current.setAuth(n||""),W.current.finishChatById(t,e),P(e=>e.filter(e=>e.id!==t))},[W,n]),G=(0,c.useCallback)((t,e)=>{W.current.setAuth(n||""),W.current.transferAttendance(t,e).then(()=>{I(e=>e.filter(e=>e.id!==t)),_()})},[W,n]),q=(0,c.useCallback)((t,e)=>{console.log("Iniciando chat",t,e),W.current.startChatByContactId(t,e)},[W,n]),H=(0,c.useCallback)(async(t,e)=>{W.current.sendMessage(t,e)},[]),_=(0,c.useCallback)(()=>{"string"==typeof n&&n.length>0&&W.current?(W.current.setAuth(n),W.current.getChatsMonitor().then(t=>{let{chats:e,messages:n}=t,{chatsMessages:a,detailedChats:c}=i(e,n);console.log("Detailed Chats:",c),P(c),R(a)})):(P([]),R({}))},[n,W.current]),O=(0,c.useCallback)(()=>{"string"==typeof n&&n.length>0&&W.current?(W.current.setAuth(n),W.current.getSchedules().then(t=>{U(t.data)})):U([])},[n,W.current]),Z=(0,c.useCallback)(()=>{"string"==typeof n&&n.length>0&&W.current?(W.current.setAuth(n),W.current.getNotifications().then(t=>{X(t)})):U([])},[n,W.current]),Y=(0,c.useCallback)(()=>{"string"==typeof n&&n.length>0&&W.current&&(W.current.setAuth(n),W.current.markAllAsReadNotification().then(t=>{Z()}))},[n,W.current]),$=(0,c.useCallback)(async(t,e)=>{try{await W.current.createSchedule({contactId:t.contactId,scheduledFor:t.userId,sectorId:t.sectorId,date:e}),m.oR.success("Agendamento criado com sucesso!")}catch(t){m.oR.error("Falha ao criar agendamento\n"+(0,d.sanitizeErrorMessage)(t)),console.error("Falha ao criar agendamento",t)}},[]),tt=(0,c.useCallback)(()=>{"string"==typeof n&&n.length>0&&W.current?(W.current.setAuth(n),W.current.getChatsBySession(!0,!0).then(t=>{let{chats:e,messages:n}=t,{chatsMessages:a,detailedChats:c}=i(e,n);I(c),R(a)}),W.current.getSectors().then(t=>N(t))):(I([]),R({}))},[n,W.current]);return(0,c.useEffect)(()=>{"string"==typeof n&&n.length>0&&W.current?(W.current.setAuth(n),W.current.getChatsBySession(!0,!0).then(t=>{let{chats:e,messages:n}=t,{chatsMessages:a,detailedChats:c}=i(e,n);I(c),R(a)}),"exatron"===C&&W.current.ax.get("/api/whatsapp/templates").then(t=>{L(t.data.templates)}),W.current.getSectors().then(t=>N(t)),Z()):(I([]),R({}))},[n,W.current,C]),(0,c.useEffect)(()=>{if(y){var t,e,n;return y.on(o.SocketEventType.WppContactMessagesRead,t=>{let{contactId:e}=t;R(t=>(t[e]&&(t[e]=t[e].map(t=>t.to.startsWith("me")&&"READ"!==t.status?{...t,status:"READ"}:t)),t)),I(t=>t.map(t=>t.contactId===e?{...t,isUnread:!1}:t)),k.current&&"wpp"===k.current.chatType&&k.current.contactId===e&&b(t=>t.map(t=>t.to.startsWith("me")&&"READ"!==t.status?{...t,status:"READ"}:t))}),y.on(o.SocketEventType.WppChatStarted,(t=W.current,async e=>{var n;let{chatId:a}=e,c=await t.getChatById(a),{messages:r,...s}=c;console.log("Chat started:",a),console.log(c);let i=null==r?void 0:r.reduce((t,e)=>+t.timestamp>+e.timestamp?t:e,r[0]);y.joinRoom("chat:".concat(s.id)),(0,l.X)("Novo atendimento!",{body:"Contato: ".concat((null===(n=s.contact)||void 0===n?void 0:n.name)||"Contato exclu\xeddo"),icon:h.A.src});let u={...s,isUnread:!0,lastMessage:i,chatType:"wpp"};R(t=>{let e={...t},n=s.contactId||0;return e[n]?e[n]=[...e[n],...r]:e[n]=r,e}),I(t=>-1!==t.findIndex(t=>t.id===s.id)?t:[u,...t]),s.type===o.WppChatType.RECEPTIVE&&(S(u),b(r))})),y.on(o.SocketEventType.WppChatFinished,async t=>{var e;let{chatId:n}=t;console.log("chat finished",n),console.log("chats",E),console.log("currentChat",w),y.leaveRoom("chat:".concat(n)),I(t=>t.filter(t=>t.id!==n));let a=E.find(t=>t.id===n);a&&(R(t=>(a.contactId&&t[a.contactId]&&delete t[a.contactId],{...t})),(0,l.X)("Atendimento finalizado!",{body:"Contato: ".concat((null===(e=a.contact)||void 0===e?void 0:e.name)||"Contato exclu\xeddo"),icon:h.A.src}),console.log(null==w?void 0:w.chatType,null==w?void 0:w.id,n),(null==w?void 0:w.chatType)==="wpp"&&w.id===n&&(S(null),b([])),Z())}),y.on(o.SocketEventType.WppChatTransfer,(e=W.current,async t=>{var n;let{chatId:a}=t;I(t=>t.filter(t=>t.id!==a));let c=E.find(t=>t.id===a);c&&(R(t=>(c.contactId&&t[c.contactId]&&delete t[c.contactId],{...t})),(0,l.X)("Atendimento Transferido!",{body:"Contato: ".concat((null===(n=c.contact)||void 0===n?void 0:n.name)||"Contato exclu\xeddo"),icon:h.A.src}),e.getChatsBySession(),console.log(null==w?void 0:w.chatType,null==w?void 0:w.id,a),(null==w?void 0:w.chatType)==="wpp"&&w.id===a&&(S(null),b([])))})),y.on(o.SocketEventType.WppMessage,(n=W.current,t=>{let{message:e}=t;if(!e.from.startsWith("me")&&!e.from.startsWith("system")){var a;let t=E.find(t=>t.contactId===e.contactId),n=e.from.split(":"),c="";3===n.length?c=n[2]:2===n.length&&(c=n[1]);let o=c.split("@")[0].replace(/\D/g,""),r=null==t?void 0:null===(a=t.contact)||void 0===a?void 0:a.name;(0,l.X)(r||d.Formatter.phone(o),{body:"chat"!==e.type?p[e.type]||"Enviou um arquivo":e.body,icon:h.A.src})}R(t=>{let n={...t},a=e.contactId||0;n[a]||(n[a]=[]);let c=n[a].findIndex(t=>t.id===e.id);return -1===c?n[a].push(e):n[a][c]=e,n});let c=k.current;I(t=>t.map(t=>t.contactId===e.contactId&&c?{...t,isUnread:c.contactId!==e.contactId,lastMessage:e}:t).sort((t,e)=>{var n,a;return((null===(n=t.lastMessage)||void 0===n?void 0:n.timestamp)||0)<((null===(a=e.lastMessage)||void 0===a?void 0:a.timestamp)||0)?1:-1})),c&&c.contactId===e.contactId&&(b(t=>{let n=[...t],a=n.findIndex(t=>t.id===e.id);return -1===a?n.push(e):n[a]=e,n}),e.to.startsWith("me")&&"READ"!==e.status&&e.contactId&&n.markContactMessagesAsRead(e.contactId||0))})),y.on(o.SocketEventType.WppMessageStatus,function(t,e,n){let a=n.current;return n=>{let{status:c,messageId:o,contactId:r}=n;t(t=>{if(!t[r])return t;let e={...t},n=e[r].findIndex(t=>t.id===o);return -1!==n&&(e[r][n].status=(0,u.A)(e[r][n].status,c)),e}),a&&"wpp"===a.chatType&&a.contactId===r&&e(t=>t.map(t=>t.id===o?{...t,status:(0,u.A)(t.status,c)}:t))}}(R,b,k)),()=>{y.off(o.SocketEventType.WppMessage),y.off(o.SocketEventType.WppChatStarted),y.off(o.SocketEventType.WppContactMessagesRead)}}},[y,E,w]),(0,a.jsx)(g.Provider,{value:{chats:E,messages:T,currentChat:w,currentChatMessages:x,openChat:z,setCurrentChat:S,finishChat:K,startChatByContactId:q,sendMessage:H,setCurrentChatMessages:b,wppApi:W,chatFilters:Q,changeChatFilters:V,updateChatContact:J,sectors:M,currentChatRef:k,transferAttendance:G,getChatsMonitor:_,monitorChats:B,getChats:tt,createSchedule:$,getMonitorSchedules:O,monitorSchedules:j,notifications:D,getNotifications:Z,markAllAsReadNotification:Y,templates:F},children:e})}let C=()=>{let t=(0,c.useContext)(g);if(!t)throw Error("useWhatsappContext must be used within a WhatsappProvider");return t}},92697:(t,e,n)=>{n.d(e,{Ay:()=>s,BR:()=>o,Us:()=>r});var a=n(95155),c=n(12115);let o=(0,c.createContext)({});function r(){let t=(0,c.useContext)(o);if(!t)throw Error("useAppContext must be used within an AppProvider");return t}function s(t){let{children:e,modal:n,setModal:r}=t;return(0,c.useEffect)(()=>{"Notification"in window&&"default"===Notification.permission&&Notification.requestPermission()},[]),(0,a.jsx)(o.Provider,{value:{modal:n,openModal:t=>{r(t)},closeModal:()=>{r(null)}},children:e})}},98892:(t,e,n)=>{n.d(e,{c:()=>d,default:()=>p,Z:()=>h});var a=n(95155),c=n(12115);let o=new(n(54607)).AuthClient("https://inpulse.infotecrs.inf.br");var r=n(38543),s=n(23464),i=n(35695),u=n(42732),l=n(49271);let d=(0,c.createContext)({});function h(){let t=(0,c.useContext)(d);if(!t)throw Error("useAuthContext must be used within an AuthProvider");return t}function p(t){let{children:e}=t,n=(0,i.useRouter)(),h=(0,i.usePathname)(),p=(0,c.useRef)(h.split("/")[1]),[f,m]=(0,c.useState)(null),[A,g]=(0,c.useState)(null),v=(0,c.useCallback)(async(t,e)=>{let{login:a,password:c}=e;try{let e=await o.login(t,a,c);localStorage.setItem("@inpulse/".concat(t,"/token"),e.token),p.current=t,m(e.user),g(e.token),s.A.defaults.headers.authorization="Bearer ".concat(e.token),n.replace("/".concat(t))}catch(t){r.oR.error("Falha ao logar!\n"+(0,u.sanitizeErrorMessage)(t))}},[n]),C=(0,c.useCallback)(()=>{g(null),localStorage.removeItem("@inpulse/".concat(p.current,"/token")),n.replace("/".concat(p.current,"/login")),m(null)},[n]);return(0,c.useEffect)(()=>{p.current=h.split("/")[1];let t=localStorage.getItem("@inpulse/".concat(p.current,"/token"));g(t),t&&(l.A.setAuth(t),o.fetchSessionData(t).then(async e=>{p.current=e.instance,s.A.defaults.headers.authorization="Bearer ".concat(t),l.A.setAuth("Bearer ".concat(t)),m(await l.A.getUserById(e.userId)),h.includes("login")&&n.replace("/".concat(p.current))}).catch(t=>{r.oR.error(t.message||"Sess\xe3o expirada, fa\xe7a o login novamente!"),localStorage.removeItem("@inpulse/".concat(p.current,"/token")),m(null),h.includes("login")||n.replace("/".concat(p.current,"/login"))})),t||h.includes("login")||n.replace("/".concat(p.current,"/login"))},[h,n]),(0,a.jsx)(d.Provider,{value:{user:f,token:A,isAuthenticated:!1,signIn:v,signOut:C,instance:p.current},children:e})}}}]);