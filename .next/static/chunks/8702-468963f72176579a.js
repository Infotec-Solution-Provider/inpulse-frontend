"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8702],{28450:(t,e,n)=>{n.d(e,{d:()=>p,A:()=>m});var a=n(95155),o=n(54607),c=n(12115),r=n(98892),s=n(92697),l=n(3127),u=n(31857),i=n(69242);function d(t){let{qr:e,phone:n}=t,{closeModal:o}=(0,c.useContext)(s.BR);return(0,a.jsxs)("div",{className:"flex h-max w-max flex-col items-center gap-2 rounded-md bg-slate-400 px-6 py-4 text-slate-800",children:[(0,a.jsxs)("div",{className:"flex w-full items-center justify-between",children:[(0,a.jsxs)("h1",{className:"text-lg font-semibold",children:[" QrCode: ",n," "]}),(0,a.jsx)(l.A,{onClick:o,children:(0,a.jsx)(i.A,{sx:{pointerEvents:"none"}})})]}),(0,a.jsx)(u.h,{value:e,height:480,width:480})]})}var h=n(38543);let p=(0,c.createContext)({});function m(t){let{children:e}=t,{token:n}=(0,c.useContext)(r.c),{openModal:l,closeModal:u}=(0,c.useContext)(s.BR),i=(0,c.useRef)(new o.SocketClient("http://localhost:8004"));return(0,c.useEffect)(()=>{n?i.current.connect(n):i.current.disconnect()},[n,i]),(0,c.useEffect)(()=>{let t=i.current;return t.on(o.SocketEventType.WwebjsQr,t=>{let{qr:e,phone:n}=t;l((0,a.jsx)(d,{qr:e,phone:n}))}),t.on(o.SocketEventType.WwebjsAuth,t=>{let{phone:e,success:n,message:a}=t;n?h.oR.success("N\xfamero ".concat(e," autenticado com sucesso!")):h.oR.error("Erro ao autenticar n\xfamero ".concat(e,": ").concat(a))}),()=>{t.off(o.SocketEventType.WwebjsQr),t.off(o.SocketEventType.WwebjsAuth)}},[i,u,l]),(0,a.jsx)(p.Provider,{value:{socket:i.current},children:e})}},37345:(t,e,n)=>{n.d(e,{A:()=>a});let a=function(t,e){return"PENDING"===t?e:"SENT"===t&&"PENDING"===e||"RECEIVED"===t&&["SENT","PENDING"].includes(e)||"READ"===t&&["SENT","PENDING","RECEIVED"].includes(e)?t:e}},49271:(t,e,n)=>{n.d(e,{A:()=>a});let a=new(n(54607)).UsersClient("http://localhost:8001")},58035:(t,e,n)=>{n.d(e,{A:()=>a});let a={src:"/_next/static/media/hlogodark.58e397dd.png",height:590,width:982,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAFCAMAAABPT11nAAAAP1BMVEVMaXHiIiW/PwDsPiPpMiOJJI3sKiXpJSTbLyPxLiXtQyTrNCX1QiTsKiSuIln1LSexH0u5IkPdKSr9LCn/PyjHk6odAAAAE3RSTlMAsgTPUUXjOhXt2LryKsjxc1/iTlJkQAAAAAlwSFlzAAAuIwAALiMBeKU/dgAAABh0RVh0U29mdHdhcmUAUGFpbnQuTkVUIDUuMS40Et+mgwAAAC1JREFUeJwFwYcBACAIwLCKIu79/60mAELyBQid+hqaZnQ3B3ScfKMBa5sz5AMV3wEXXx6ffwAAAABJRU5ErkJggg==",blurWidth:8,blurHeight:5}},67737:(t,e,n)=>{n.d(e,{X:()=>a});function a(t,e){"Notification"in window&&"granted"===Notification.permission&&new Notification(t,e)}},88702:(t,e,n)=>{n.d(e,{M1:()=>A,ce:()=>g,Ay:()=>v,jb:()=>C});var a=n(95155),o=n(12115),c=n(54607),r=n(98892),s=n(28450);function l(t,e){e.sort((t,e)=>(t.timestamp||0)<(e.timestamp||0)?-1:1);let n={},a={};for(let t of e){let e=t.contactId||0;a[e]||(a[e]=[]),a[e].push(t),(!n[e]||t.timestamp>n[e].timestamp)&&(n[e]=t)}let o=t=>t.from.startsWith("me:")||"system"===t.from,c=[];for(let a of t){let t={...a,chatType:"wpp",isUnread:e.some(t=>t.contactId===a.contactId&&"READ"!==t.status&&!o(t)),lastMessage:a.contactId&&n[a.contactId]||null};c.push(t)}return c.sort((t,e)=>{var n,a;return((null===(n=t.lastMessage)||void 0===n?void 0:n.timestamp)||0)<((null===(a=e.lastMessage)||void 0===a?void 0:a.timestamp)||0)?1:-1}),{detailedChats:c,chatsMessages:a}}var u=n(37345),i=n(67737),d=n(42732),h=n(58035);let p={image:"Enviou uma imagem.",video:"Enviou um v\xeddeo.",audio:"Enviou um \xe1udio.",ptt:"Enviou uma mensagem de voz.",document:"Enviou um documento.",file:"Enviou um arquivo."};function m(t,e){switch(e.type){case"change-showing-type":return{...t,showingType:e.showingType};case"change-search":return{...t,search:e.search};case"reset-filters":return{showingType:"all",search:""};default:return t}}var f=n(38543);let A="http://localhost:8005",g=(0,o.createContext)({});function v(t){let{children:e}=t,{token:n,user:v,instance:C}=(0,o.useContext)(r.c),{socket:y}=(0,o.useContext)(s.d),[E,I]=(0,o.useState)([]),[w,S]=(0,o.useState)(null),k=(0,o.useRef)(null),[x,T]=(0,o.useState)([]),[b,R]=(0,o.useState)({}),[M,N]=(0,o.useState)([]),W=(0,o.useRef)(new c.WhatsappClient(A)),[B,P]=(0,o.useState)([]),[j,U]=(0,o.useState)([]),[D,X]=(0,o.useState)([]),[F,L]=(0,o.useState)([]),[Q,V]=(0,o.useReducer)(m,{search:"",showingType:"all"}),z=(0,o.useCallback)(t=>{S(t),T(b[t.contactId||0]||[]),k.current=t,t.contactId&&(W.current.markContactMessagesAsRead(t.contactId),I(e=>e.map(e=>e.id===t.id?{...e,isUnread:!1}:e)))},[b]),J=(0,o.useCallback)((t,e)=>{I(n=>n.map(n=>n.contact&&n.contactId===t?{...n,contact:{...n.contact,name:e}}:n)),w&&"wpp"===w.chatType&&w.contactId===t&&S(t=>(t.contact.name=e,t))},[w]),K=(0,o.useCallback)((t,e)=>{W.current.setAuth(n||""),W.current.finishChatById(t,e),P(e=>e.filter(e=>e.id!==t))},[W,n]),G=(0,o.useCallback)((t,e)=>{W.current.setAuth(n||""),W.current.transferAttendance(t,e).then(()=>{I(e=>e.filter(e=>e.id!==t)),_()})},[W,n]),q=(0,o.useCallback)((t,e)=>{console.log("Iniciando chat",t,e),W.current.startChatByContactId(t,e)},[W,n]),H=(0,o.useCallback)(async(t,e)=>{W.current.sendMessage(t,e)},[]),_=(0,o.useCallback)(()=>{"string"==typeof n&&n.length>0&&W.current?(W.current.setAuth(n),W.current.getChatsMonitor().then(t=>{let{chats:e,messages:n}=t,{chatsMessages:a,detailedChats:o}=l(e,n);console.log("Detailed Chats:",o),P(o),R(a)})):(P([]),R({}))},[n,W.current]),O=(0,o.useCallback)(()=>{"string"==typeof n&&n.length>0&&W.current?(W.current.setAuth(n),W.current.getSchedules().then(t=>{U(t.data)})):U([])},[n,W.current]),Z=(0,o.useCallback)(()=>{"string"==typeof n&&n.length>0&&W.current?(W.current.setAuth(n),W.current.getNotifications().then(t=>{X(t)})):U([])},[n,W.current]),Y=(0,o.useCallback)(()=>{"string"==typeof n&&n.length>0&&W.current&&(W.current.setAuth(n),W.current.markAllAsReadNotification().then(t=>{Z()}))},[n,W.current]),$=(0,o.useCallback)(async(t,e)=>{try{await W.current.createSchedule({contactId:t.contactId,scheduledFor:t.userId,sectorId:t.sectorId,date:e}),f.oR.success("Agendamento criado com sucesso!")}catch(t){f.oR.error("Falha ao criar agendamento\n"+(0,d.sanitizeErrorMessage)(t)),console.error("Falha ao criar agendamento",t)}},[]),tt=(0,o.useCallback)(()=>{"string"==typeof n&&n.length>0&&W.current?(W.current.setAuth(n),W.current.getChatsBySession(!0,!0).then(t=>{let{chats:e,messages:n}=t,{chatsMessages:a,detailedChats:o}=l(e,n);I(o),R(a)}),W.current.getSectors().then(t=>N(t))):(I([]),R({}))},[n,W.current]);return(0,o.useEffect)(()=>{"string"==typeof n&&n.length>0&&W.current?(W.current.setAuth(n),W.current.getChatsBySession(!0,!0).then(t=>{let{chats:e,messages:n}=t,{chatsMessages:a,detailedChats:o}=l(e,n);I(o),R(a)}),"exatron"===C&&W.current.ax.get("/api/whatsapp/templates").then(t=>{L(t.data.templates)}),W.current.getSectors().then(t=>N(t)),Z()):(I([]),R({}))},[n,W.current,C]),(0,o.useEffect)(()=>{if(y){var t,e,n;return y.on(c.SocketEventType.WppContactMessagesRead,t=>{let{contactId:e}=t;R(t=>(t[e]&&(t[e]=t[e].map(t=>t.to.startsWith("me")&&"READ"!==t.status?{...t,status:"READ"}:t)),t)),I(t=>t.map(t=>t.contactId===e?{...t,isUnread:!1}:t)),k.current&&"wpp"===k.current.chatType&&k.current.contactId===e&&T(t=>t.map(t=>t.to.startsWith("me")&&"READ"!==t.status?{...t,status:"READ"}:t))}),y.on(c.SocketEventType.WppChatStarted,(t=W.current,async e=>{var n;let{chatId:a}=e,o=await t.getChatById(a),{messages:r,...s}=o;console.log("Chat started:",a),console.log(o);let l=null==r?void 0:r.reduce((t,e)=>+t.timestamp>+e.timestamp?t:e,r[0]);y.joinRoom("chat:".concat(s.id)),(0,i.X)("Novo atendimento!",{body:"Contato: ".concat((null===(n=s.contact)||void 0===n?void 0:n.name)||"Contato exclu\xeddo"),icon:h.A.src});let u={...s,isUnread:!0,lastMessage:l,chatType:"wpp"};R(t=>{let e={...t},n=s.contactId||0;return e[n]?e[n]=[...e[n],...r]:e[n]=r,e}),I(t=>-1!==t.findIndex(t=>t.id===s.id)?t:[u,...t]),s.type===c.WppChatType.RECEPTIVE&&(S(u),T(r))})),y.on(c.SocketEventType.WppChatFinished,async t=>{var e;let{chatId:n}=t;console.log("chat finished",n),console.log("chats",E),console.log("currentChat",w),y.leaveRoom("chat:".concat(n)),I(t=>t.filter(t=>t.id!==n));let a=E.find(t=>t.id===n);a&&(R(t=>(a.contactId&&t[a.contactId]&&delete t[a.contactId],{...t})),(0,i.X)("Atendimento finalizado!",{body:"Contato: ".concat((null===(e=a.contact)||void 0===e?void 0:e.name)||"Contato exclu\xeddo"),icon:h.A.src}),console.log(null==w?void 0:w.chatType,null==w?void 0:w.id,n),(null==w?void 0:w.chatType)==="wpp"&&w.id===n&&(S(null),T([])),Z())}),y.on(c.SocketEventType.WppChatTransfer,(e=W.current,async t=>{var n;let{chatId:a}=t;I(t=>t.filter(t=>t.id!==a));let o=E.find(t=>t.id===a);o&&(R(t=>(o.contactId&&t[o.contactId]&&delete t[o.contactId],{...t})),(0,i.X)("Atendimento Transferido!",{body:"Contato: ".concat((null===(n=o.contact)||void 0===n?void 0:n.name)||"Contato exclu\xeddo"),icon:h.A.src}),e.getChatsBySession(),console.log(null==w?void 0:w.chatType,null==w?void 0:w.id,a),(null==w?void 0:w.chatType)==="wpp"&&w.id===a&&(S(null),T([])))})),y.on(c.SocketEventType.WppMessage,(n=W.current,t=>{let{message:e}=t;if(!e.from.startsWith("me")&&!e.from.startsWith("system")){var a;let t=E.find(t=>t.contactId===e.contactId),n=e.from.split(":"),o="";3===n.length?o=n[2]:2===n.length&&(o=n[1]);let c=o.split("@")[0].replace(/\D/g,""),r=null==t?void 0:null===(a=t.contact)||void 0===a?void 0:a.name;(0,i.X)(r||d.Formatter.phone(c),{body:"chat"!==e.type?p[e.type]||"Enviou um arquivo":e.body,icon:h.A.src})}R(t=>{let n={...t},a=e.contactId||0;n[a]||(n[a]=[]);let o=n[a].findIndex(t=>t.id===e.id);return -1===o?n[a].push(e):n[a][o]=e,n});let o=k.current;I(t=>t.map(t=>t.contactId===e.contactId&&o?{...t,isUnread:o.contactId!==e.contactId,lastMessage:e}:t).sort((t,e)=>{var n,a;return((null===(n=t.lastMessage)||void 0===n?void 0:n.timestamp)||0)<((null===(a=e.lastMessage)||void 0===a?void 0:a.timestamp)||0)?1:-1})),o&&o.contactId===e.contactId&&(T(t=>{let n=[...t],a=n.findIndex(t=>t.id===e.id);return -1===a?n.push(e):n[a]=e,n}),e.to.startsWith("me")&&"READ"!==e.status&&e.contactId&&n.markContactMessagesAsRead(e.contactId||0))})),y.on(c.SocketEventType.WppMessageStatus,function(t,e,n){let a=n.current;return n=>{let{status:o,messageId:c,contactId:r}=n;t(t=>{if(!t[r])return t;let e={...t},n=e[r].findIndex(t=>t.id===c);return -1!==n&&(e[r][n].status=(0,u.A)(e[r][n].status,o)),e}),a&&"wpp"===a.chatType&&a.contactId===r&&e(t=>t.map(t=>t.id===c?{...t,status:(0,u.A)(t.status,o)}:t))}}(R,T,k)),()=>{y.off(c.SocketEventType.WppMessage),y.off(c.SocketEventType.WppChatStarted),y.off(c.SocketEventType.WppContactMessagesRead)}}},[y,E,w]),(0,a.jsx)(g.Provider,{value:{chats:E,messages:b,currentChat:w,currentChatMessages:x,openChat:z,setCurrentChat:S,finishChat:K,startChatByContactId:q,sendMessage:H,setCurrentChatMessages:T,wppApi:W,chatFilters:Q,changeChatFilters:V,updateChatContact:J,sectors:M,currentChatRef:k,transferAttendance:G,getChatsMonitor:_,monitorChats:B,getChats:tt,createSchedule:$,getMonitorSchedules:O,monitorSchedules:j,notifications:D,getNotifications:Z,markAllAsReadNotification:Y,templates:F},children:e})}let C=()=>{let t=(0,o.useContext)(g);if(!t)throw Error("useWhatsappContext must be used within a WhatsappProvider");return t}},92697:(t,e,n)=>{n.d(e,{Ay:()=>s,BR:()=>c,Us:()=>r});var a=n(95155),o=n(12115);let c=(0,o.createContext)({});function r(){let t=(0,o.useContext)(c);if(!t)throw Error("useAppContext must be used within an AppProvider");return t}function s(t){let{children:e,modal:n,setModal:r}=t;return(0,o.useEffect)(()=>{"Notification"in window&&"default"===Notification.permission&&Notification.requestPermission()},[]),(0,a.jsx)(c.Provider,{value:{modal:n,openModal:t=>{r(t)},closeModal:()=>{r(null)}},children:e})}},98892:(t,e,n)=>{n.d(e,{c:()=>d,default:()=>p,Z:()=>h});var a=n(95155),o=n(12115);let c=new(n(54607)).AuthClient("http://localhost:8001");var r=n(38543),s=n(23464),l=n(35695),u=n(42732),i=n(49271);let d=(0,o.createContext)({});function h(){let t=(0,o.useContext)(d);if(!t)throw Error("useAuthContext must be used within an AuthProvider");return t}function p(t){let{children:e}=t,n=(0,l.useRouter)(),h=(0,l.usePathname)(),p=(0,o.useRef)(h.split("/")[1]),[m,f]=(0,o.useState)(null),[A,g]=(0,o.useState)(null),v=(0,o.useCallback)(async(t,e)=>{let{login:a,password:o}=e;try{let e=await c.login(t,a,o);localStorage.setItem("@inpulse/".concat(t,"/token"),e.token),p.current=t,f(e.user),g(e.token),s.A.defaults.headers.authorization="Bearer ".concat(e.token),n.replace("/".concat(t))}catch(t){r.oR.error("Falha ao logar!\n"+(0,u.sanitizeErrorMessage)(t))}},[n]),C=(0,o.useCallback)(()=>{g(null),localStorage.removeItem("@inpulse/".concat(p.current,"/token")),n.replace("/".concat(p.current,"/login")),f(null)},[n]);return(0,o.useEffect)(()=>{p.current=h.split("/")[1];let t=localStorage.getItem("@inpulse/".concat(p.current,"/token"));g(t),t&&(i.A.setAuth(t),c.fetchSessionData(t).then(async e=>{p.current=e.instance,s.A.defaults.headers.authorization="Bearer ".concat(t),i.A.setAuth("Bearer ".concat(t)),f(await i.A.getUserById(e.userId)),h.includes("login")&&n.replace("/".concat(p.current))}).catch(t=>{r.oR.error(t.message||"Sess\xe3o expirada, fa\xe7a o login novamente!"),localStorage.removeItem("@inpulse/".concat(p.current,"/token")),f(null),h.includes("login")||n.replace("/".concat(p.current,"/login"))})),t||h.includes("login")||n.replace("/".concat(p.current,"/login"))},[h,n]),(0,a.jsx)(d.Provider,{value:{user:m,token:A,isAuthenticated:!1,signIn:v,signOut:C,instance:p.current},children:e})}}}]);