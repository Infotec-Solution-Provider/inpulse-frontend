"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{40931:(e,t,n)=>{n.d(t,{xI:()=>x,l1:()=>I,Ay:()=>A});var a=n(95155),r=n(12115),l=n(54607),s=n(98892),i=n(28450),o=n(37345),c=n(67737),u=n(58035),d=n(42732);let h={image:"Enviou uma imagem.",video:"Enviou um v\xeddeo.",audio:"Enviou um \xe1udio.",ptt:"Enviou uma mensagem de voz.",document:"Enviou um documento.",file:"Enviou um arquivo."},p=new Set;function m(e,t,n,a){let r=new Map;n.forEach(e=>r.set(e.id,e)),a.sort((e,t)=>(e.timestamp||0)<(t.timestamp||0)?-1:1);let l={},s={};for(let t of a){let n=r.get(t.internalChatId),a=null==n?void 0:n.participants.find(t=>t.userId===e);if(a&&a.lastReadAt){let n=new Date(a.lastReadAt).getTime(),r=+t.timestamp,l=t.from==="user:".concat(e);n>=r&&"READ"!==t.status&&!l&&(t.status="READ")}s[t.internalChatId]||(s[t.internalChatId]=[]),s[t.internalChatId].push(t),(!l[t.internalChatId]||t.timestamp>l[t.internalChatId].timestamp)&&(l[t.internalChatId]=t)}let i=t=>t.from==="user:".concat(e),o=(e,t)=>t.id===e.internalChatId,c=n.map(e=>({...e,chatType:"internal",isUnread:a.some(t=>o(t,e)&&!i(t)&&"READ"!==t.status),lastMessage:l[e.id]||null,users:t.filter(t=>e.participants.some(e=>e.userId===t.CODIGO))}));return c.sort((e,t)=>{var n,a;return((null===(n=e.lastMessage)||void 0===n?void 0:n.timestamp)||0)<((null===(a=t.lastMessage)||void 0===a?void 0:a.timestamp)||0)?1:-1}),{detailedChats:c,chatsMessages:s}}var f=n(49271),C=n(88702),g=n(38543),v=n(56204);let x=(0,r.createContext)({});function A(){let e=(0,r.useContext)(x);if(!e)throw Error("useInternalChatContext must be used within an InternalChatProvider");return e}function I(e){let{children:t}=e,{socket:n}=(0,r.useContext)(i.d),{setCurrentChat:A,currentChatRef:I,setCurrentChatMessages:y,chats:k}=(0,C.jb)(),[j,E]=(0,r.useState)([]),[D,S]=(0,r.useState)([]),[b,w]=(0,r.useState)({}),[R,M]=(0,r.useState)([]),[O,T]=(0,r.useState)({}),{contacts:P}=(0,r.useContext)(v.Jj),[W,G]=(0,r.useState)([]),N=(0,r.useRef)(new l.InternalChatClient("https://inpulse.infotecrs.inf.br")),{token:F,user:U}=(0,r.useContext)(s.c);(0,r.useEffect)(()=>{let e="InPulse",t=[...j,...k].filter(e=>e.isUnread);return t.length>0?document.title="\uD83D\uDD14 InPulse (".concat(t.length,")"):document.title=e,()=>{document.title=e}},[j,k]);let z=(0,r.useCallback)(function(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];A(e),G(b[e.id]||O[e.id]||[]),y([]),I.current=e,t&&(N.current.markChatMessagesAsRead(e.id),E(t=>t.map(t=>t.id===e.id?{...t,isUnread:!1}:t)))},[b]),H=async e=>{if(N.current)try{await N.current.deleteInternalChat(e),g.oR.success("Chat deletado com sucesso!"),E(t=>t.filter(t=>t.id!==e))}catch(e){g.oR.error("Erro ao deletar Chat")}},L=(0,r.useCallback)(e=>{F&&(N.current.setAuth(F),N.current.sendMessageToInternalChat(e))},[F]);(0,r.useEffect)(()=>{F&&0===D.length&&(f.A.setAuth(F),f.A.getUsers({perPage:"999"}).then(e=>S(e.data))),F&&U&&D.length>0?(N.current.setAuth(F),N.current.getInternalChatsBySession().then(e=>{let{chats:t,messages:n}=e,{chatsMessages:a,detailedChats:r}=m(U.CODIGO,D,t||[],n||[]);E(r||[]),w(a||[])})):(E([]),w({}))},[F,N.current,U,D]);let _=(0,r.useCallback)(e=>{F&&U&&N.current.createInternalChat([e,U.CODIGO],!1,"")},[N,F,U]),q=(0,r.useCallback)(()=>{F&&U&&D.length>0?(N.current.setAuth(F),N.current.getInternalChatsMonitor().then(e=>{let{chats:t,messages:n}=e;console.log("Monitorando conversas internas",t,n);let{chatsMessages:a,detailedChats:r}=m(U.CODIGO,D,t||[],n||[]);M(r||[]),T(a||[])})):(E([]),T({}))},[F,N.current,U,D]);return(0,r.useEffect)(()=>{if(n&&U&&D.length>0){var e;return n.on(l.SocketEventType.InternalChatStarted,async e=>{let{chat:t}=e;n.joinRoom("internal-chat:".concat(t.id));let a={...t,lastMessage:t.messages[t.messages.length-1]||null,chatType:"internal",isUnread:!0,users:D.filter(e=>t.participants.some(t=>t.userId===e.CODIGO))};E(e=>e.some(e=>e.id===t.id)?e:[a,...e]),w(e=>{let n=e[t.id]||[],a=t.messages.filter(e=>!n.some(t=>t.id===e.id));return{...e,[t.id]:[...a,...n]}}),U.CODIGO===t.creatorId&&z(a)}),n.on(l.SocketEventType.InternalChatFinished,async e=>{var t;let{chatId:a}=e;n.leaveRoom("internal-chat:".concat(a)),E(e=>e.filter(e=>e.id!==a));let r=j.find(e=>e.id===a);r&&(w(e=>(e[r.id]&&delete e[r.id],{...e})),(null===(t=I.current)||void 0===t?void 0:t.chatType)==="internal"&&I.current.id===a&&(A(null),G([])))}),n.on(l.SocketEventType.InternalMessage,(e=N.current,t=>{var n,a,r;let{message:l}=t;if(p.has(l.id))return;p.add(l.id);let s=(null===(n=I.current)||void 0===n?void 0:n.chatType)==="internal"&&I.current.id===l.internalChatId,i=l.from==="user:".concat(U.CODIGO);if(s&&!i&&(e.markChatMessagesAsRead(l.internalChatId),l={...l,status:"READ"}),s&&G(e=>e.some(e=>e.id===l.id)?e:[...e,l]),l.from!=="user:".concat(U.CODIGO)){let e="Desconhecido";if("system"===l.from&&(e="InPulse"),l.from.startsWith("user:")&&(e=(null===(a=D.find(e=>e.CODIGO===+l.from.split(":")[1]))||void 0===a?void 0:a.NOME)||"Desconhecido"),l.from.startsWith("external:")){let t=l.from.split(":"),n="";3===t.length?n=t[2]:2===t.length&&(n=t[1]);let a=n.split("@")[0].replace(/\D/g,""),s=D.find(e=>e.WHATSAPP===a),i=null===(r=P.find(e=>e.phone===a))||void 0===r?void 0:r.name;e=s?s.NOME||i||(s.WHATSAPP&&s.WHATSAPP.length<=13?d.Formatter.phone(s.WHATSAPP):"Sem n\xfamero"):i||(a.length<=13?d.Formatter.phone(a):a)}let t="chat"!==l.type?h[l.type]||"Enviou um arquivo":function(e,t,n){let a=e.match(/@(\w+)/g);if(!a)return e;function r(e){let a=Number(e);if(!isNaN(a)){let r=t.find(t=>t.CODIGO===a||t.WHATSAPP===e);if(r)return r.NOME;{let t=n.find(t=>t.phone===e);if(t)return t.name}}return"@".concat(e)}return e.trim().split(/\s+/).every(e=>/@\w+/.test(e))&&a?a.map(e=>r(e.slice(1))).map(e=>"Mencionou ".concat(e)).join(", "):e.replace(/@(\w+)/g,(e,t)=>r(t))}(l.body||"",D,P);(0,c.X)(e,{body:t,icon:u.A.src})}w(e=>{let t={...e},n=l.internalChatId;t[n]||(t[n]=[]);let a=t[n].findIndex(e=>e.id===l.id);return -1===a?t[n].push(l):t[n][a]=l,t}),E(e=>e.map(e=>{if(e.id===l.internalChatId){var t;return{...e,isUnread:(null===(t=I.current)||void 0===t?void 0:t.id)!==l.internalChatId,lastMessage:l}}return e}))})),n.on(l.SocketEventType.InternalMessageStatus,e=>{let{status:t,internalMessageId:n,chatId:a}=e;w(e=>{let r={...e};return r[a]&&(r[a]=r[a].map(e=>e.id===n?{...e,status:(0,o.A)(e.status,t)}:e)),r}),I.current&&"internal"===I.current.chatType&&I.current.id===a&&G(e=>e.map(e=>e.id===n?{...e,status:(0,o.A)(e.status,t)}:e))}),()=>{n.off(l.SocketEventType.InternalChatStarted),n.off(l.SocketEventType.InternalMessage),n.off(l.SocketEventType.InternalMessageStatus),n.off(l.SocketEventType.InternalChatFinished)}}},[n,U,D,W]),(0,a.jsx)(x.Provider,{value:{internalApi:N,internalChats:j,messages:b,setCurrentChat:A,sendInternalMessage:L,startDirectChat:_,openInternalChat:z,currentInternalChatMessages:W,users:D,monitorInternalChats:R,getInternalChatsMonitor:q,monitorMessages:O,deleteInternalChat:H},children:t})}},56204:(e,t,n)=>{n.d(t,{Jj:()=>j,Ay:()=>D,GC:()=>E});var a=n(95155),r=n(12115),l=n(54607),s=n(98892),i=n(42732),o=n(38543),c=n(88702),u=n(16324),d=n(27943),h=n(56278),p=n(54492),m=n(3127),f=n(99927),C=n(73731),g=n(22883),v=n(71977),x=n(68534),A=n(69242);function I(e){let{contact:t}=e,{closeModal:n,modal:l,createContact:s,updateContact:i}=E(),c=!!t,[I,y]=(0,r.useState)((null==t?void 0:t.name)||""),[k,j]=(0,r.useState)("+55"),[D,S]=(0,r.useState)(""),b=(0,u.A)(),w=(0,d.A)(b.breakpoints.down("sm")),R=e=>{let t=e.replace(/\D/g,"");return t.length<=2?"(".concat(t):t.length<=6?"(".concat(t.slice(0,2),") ").concat(t.slice(2)):t.length<=10?"(".concat(t.slice(0,2),") ").concat(t.slice(2,6),"-").concat(t.slice(6)):"(".concat(t.slice(0,2),") ").concat(t.slice(2,7),"-").concat(t.slice(7,11))};return(0,a.jsxs)(h.A,{open:!!l,onClose:(e,t)=>{"backdropClick"!==t&&n()},fullScreen:w,maxWidth:!1,sx:{"& .MuiDialog-paper":{width:"360px",maxWidth:"90vw",borderRadius:3,padding:2}},children:[(0,a.jsxs)(p.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 16px"},children:[c?"Editar Contato":"Cadastrar Contato",(0,a.jsx)(m.A,{onClick:n,children:(0,a.jsx)(A.A,{})})]}),(0,a.jsxs)(f.A,{sx:{display:"flex",flexDirection:"column",gap:2,paddingTop:5},children:[(0,a.jsx)(C.A,{label:"Nome",fullWidth:!0,value:I,onChange:e=>y(e.target.value),variant:"filled"}),!c&&(0,a.jsxs)(g.A,{direction:"row",spacing:1,children:[(0,a.jsx)(C.A,{label:"DDI",value:k,onChange:e=>j(e.target.value),sx:{width:"80px"},variant:"filled"}),(0,a.jsx)(C.A,{label:"N\xfamero",placeholder:"(11) 91234-5678",fullWidth:!0,value:D,variant:"filled",onChange:e=>S(R(e.target.value))})]})]}),(0,a.jsxs)(v.A,{sx:{justifyContent:"flex-end"},children:[(0,a.jsx)(x.A,{color:"error",onClick:n,children:"Cancelar"}),(0,a.jsx)(x.A,{variant:"contained",onClick:()=>{if(!I.trim()){o.oR.error("O nome \xe9 obrigat\xf3rio!");return}if(c)i(t.id,I);else{if(!D.trim()||!k.trim()){o.oR.error("Telefone completo (DDI + N\xfamero) \xe9 obrigat\xf3rio!");return}s(I,"".concat(k).concat(D.replace(/\D/g,"")))}n()},children:c?"Salvar":"Cadastrar"})]})]})}var y=n(700);function k(e){let{contact:t}=e,{deleteContact:n,closeModal:r}=E(),l=(0,u.A)(),s=(0,d.A)(l.breakpoints.down("sm"));return(0,a.jsxs)(h.A,{open:!0,onClose:(e,t)=>{"backdropClick"!==t&&r()},fullScreen:s,maxWidth:!1,sx:{"& .MuiDialog-paper":{width:"360px",maxWidth:"90vw",borderRadius:3,padding:2}},children:[(0,a.jsxs)(p.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 16px"},children:["Deletar Contato",(0,a.jsx)(m.A,{onClick:r,children:(0,a.jsx)(A.A,{})})]}),(0,a.jsx)(f.A,{sx:{display:"flex",flexDirection:"column",gap:2,paddingTop:5},children:(0,a.jsxs)(y.A,{variant:"body1",children:["Tem certeza que deseja excluir o contato"," ",(0,a.jsxs)("strong",{style:{color:l.palette.error.main},children:['"',t.name,'"']}),"?"]})}),(0,a.jsxs)(v.A,{sx:{justifyContent:"flex-end"},children:[(0,a.jsx)(x.A,{color:"error",onClick:r,children:"Cancelar"}),(0,a.jsx)(x.A,{variant:"contained",color:"error",onClick:()=>{n(t.id),r()},children:"Deletar"})]})]})}let j=(0,r.createContext)({}),E=()=>(0,r.useContext)(j);function D(e){let{children:t}=e,n=(0,r.useRef)(new l.WhatsappClient(c.M1)),{token:u}=(0,s.Z)(),[d,h]=(0,r.useState)([]),[p,m]=(0,r.useState)(!1),[f,C]=(0,r.useState)(null),g=(0,r.useCallback)(async(e,t)=>{try{if(u){let a=await n.current.updateContact(e,t);h(t=>t.map(t=>t.id===e?a:t)),y(),o.oR.success("Cliente atualizado com sucesso!")}}catch(e){i.Logger.error("Error updating contact",e),o.oR.error("Falha ao atualizar cliente!")}},[u]),v=(0,r.useCallback)(async e=>{try{u&&(await n.current.deleteContact(e),h(t=>t.filter(t=>t.id!==e)),o.oR.success("Contato deletado com sucesso!"))}catch(e){i.Logger.error("Error deleting contact",e),o.oR.error("Falha ao deletar cliente!")}},[u]),x=(0,r.useCallback)(async(e,t)=>{try{if(u){let a=await n.current.createContact(e,t.replace(/\D/g,""));h(e=>[...e,a]),o.oR.success("Contato criado com sucesso!"),y()}}catch(e){i.Logger.error("Error criar contact",e),o.oR.error("Falha ao atualizar cliente!")}},[u]),A=(0,r.useCallback)(e=>{C((0,a.jsx)(I,{contact:e}))},[x,g]),y=(0,r.useCallback)(()=>{C(null)},[]),E=(0,r.useCallback)(e=>{C((0,a.jsx)(k,{contact:e}))},[v]),D=(0,r.useCallback)(async()=>{try{m(!0);let e=await n.current.getContacts();h(e)}catch(e){i.Logger.error("Error loading contacts",e),o.oR.error("Falha ao carregar clientes!")}finally{m(!1)}},[]);return(0,r.useEffect)(()=>{u&&n.current&&(n.current.setAuth(u),D())},[u,n.current]),(0,a.jsxs)(j.Provider,{value:{contacts:d,updateContact:g,loadContacts:D,createContact:x,deleteContact:v,isLoading:p,openContactModal:A,closeModal:y,modal:f,handleDeleteContact:E},children:[t,f]})}}}]);